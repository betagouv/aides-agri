{% extends "ui/base.html" %}

{% load static i18n dsfr_tags ui_tags %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'ui/components/select-rich.css' %}">
  <link rel="stylesheet" href="{% static 'agri_v2/results.css' %}">
  <link rel="stylesheet" href="{% static 'aides_feedback/base.css' %}">
{% endblock extra_css %}

{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
// handle print button
document.onreadystatechange = evt => {
  document.getElementById("button-print").onclick = () => window.print()
}
// catch external links to open a confirmation modal
document.querySelectorAll("a[href][target=_blank]").forEach(elt => {
  elt.addEventListener("click", evt => {
    evt.preventDefault()
    const href = elt.getAttribute("href")
    document.getElementById("modal-external-link-domain").textContent = href.split("/")[2]
    document.getElementById("modal-external-link-href").setAttribute("href", href)
    window.dsfr(document.getElementById("modal-external-link")).modal.disclose()
  })
})
</script>
<script type="module" nonce="{{ request.csp_nonce }}">
  import { Application } from "stimulus"
  import { Alert } from "alert"
  import { SelectRich } from "select-rich"

  window.Stimulus ??= Application.start()

  Stimulus.register("alert", Alert)
  Stimulus.register("select-rich", SelectRich)
</script>
{% endblock extra_js %}

{% block breadcrumb %}{% endblock %}

{% block modals %}
{% if aides %}
<dialog class="fr-modal"
        id="modal-send-by-mail"
        aria-labelledby="modal-send-by-mail-title"
>
  <div class="fr-container fr-container--fluid fr-container-md">
    <div class="fr-grid-row fr-grid-row--center">
      <div class="fr-col-12 fr-col-md-8 fr-col-lg-7">
        <div class="fr-modal__body">
          <form method="post"
                action="{% url 'agri:send-results-by-mail' %}{% querystring %}"
                hx-boost="true"
                hx-target="#alert-placeholder"
                hx-swap="innerHTML show:none"
                hx-push-url="false"
          >
            {% csrf_token %}
            <div class="fr-modal__header">
              <button type="button" class="fr-btn--close fr-btn" aria-controls="modal-send-by-mail">Fermer</button>
            </div>
            <div class="fr-modal__content" id="modal-send-by-mail-content">
              <h1 id="modal-send-by-mail-title" class="fr-modal__title">
                <span class="fr-icon-arrow-right-line fr-icon--lg"></span>
                S’envoyer les résultats de la recherche par e-mail.
              </h1>
              <p>Partagez-nous votre adresse e-mail pour recevoir vos résultats dans votre boite e-mail. Nous utiliserons votre adresse e-mail seulement à cet effet.</p>
                <div class="fr-input-group">
                  <label for="send-by-mail-field-email" class="fr-label">
                    Adresse de courrier électronique
                    <span class="fr-hint-text">Format attendu : nom@domaine.fr</span>
                  </label>
                  <input type="email"
                         name="email"
                         id="send-by-mail-field-email"
                         class="fr-input"
                         required
                  >
                </div>
            </div>
            <div class="fr-modal__footer" id="modal-send-results-by-mail-footer">
              <div class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left">
                <button type="submit"
                        class="fr-btn fr-icon-checkbox-circle-line fr-btn--icon-left"
                        aria-controls="modal-send-by-mail"
                >
                  Envoyer par e-mail
                </button>
                <button type="button"
                        class="fr-btn fr-btn--secondary"
                        aria-controls="modal-send-by-mail"
                >
                  Annuler
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</dialog>
{% endif %}
<dialog class="fr-modal"
        id="modal-external-link"
        aria-labelledby="modal-external-link-title"
        aria-modal="true"
>
  <div class="fr-container fr-container--fluid fr-container-md">
    <div class="fr-grid-row fr-grid-row--center">
      <div class="fr-col-12 fr-col-md-8 fr-col-lg-7">
        <div class="fr-modal__body">
            <div class="fr-modal__header">
              <button type="button" class="fr-btn--close fr-btn" aria-controls="modal-external-link">Fermer</button>
            </div>
            <div class="fr-modal__content" id="modal-external-link-content">
              <h1 id="modal-external-link-title" class="fr-modal__title">
                <span class="fr-icon-arrow-right-line fr-icon--lg"></span>
                Ce lien vous envoie vers un site externe.
              </h1>
              <p>
                Acceptez-vous la redirection vers <strong id="modal-external-link-domain"></strong> ?
                Le lien s’ouvrira dans un nouvel onglet ou une nouvelle fenêtre.
              </p>
            </div>
            <div class="fr-modal__footer" id="modal-external-link-footer">
              <div class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left">
                <a class="fr-btn"
                   id="modal-external-link-href"
                   target="_blank"
                   aria-controls="modal-external-link"
                >
                  D’accord
                </a>
                <button type="button"
                        class="fr-btn fr-btn--secondary"
                        aria-controls="modal-external-link"
                >
                  Annuler
                </button>
              </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</dialog>
{% endblock modals %}

{% block title %}Votre recherche{% endblock title %}

{% block content %}
  <div id="alert-placeholder"></div>

  <h1 class="fr-mb-1w">Votre recherche</h1>
  <p class="fr-text--xl">
    {% if paginator.count %}
      {{ paginator.count }}
      dispositif{{ paginator.count|pluralize }}
      correspond{{ paginator.count|pluralize:"ent" }}
    {% else %}
      Aucun dispositif ne correspond
    {% endif %}
    à votre recherche.
  </p>

  <form id="filters"
        class="fr-container-fluid"
        action=""
        hx-boost="true"
        hx-trigger="change"
        hx-select="#content"
        hx-target="#content"
        hx-swap="outerHTML"
  >
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col">
        <div class="fr-search-bar fr-mb-2w" role="search">
          <label class="fr-label" for="search-input">
              Rechercher
          </label>
          <input class="fr-input" placeholder="Recherche par mots-clés : remplacement matériel, financement irrigation, etc." id="search-input" type="search" name="q" value="{{ request.GET.q }}">
          <button title="Rechercher" type="button" class="fr-btn">Rechercher</button>
        </div>
      </div>
    </div>
    <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--bottom fr-my-1w">
      <div class="fr-col fr-col-sm-6 fr-col-lg-4 fr-py-0-5v fr-px-2v">
        {% ui_select_rich_multi label="Département" name="departements" searchable=True options=filter_departements initials=filter_departements_initials %}
      </div>
      <div class="fr-col fr-col-sm-6 fr-col-lg-4 fr-col-offset-lg-4--right fr-py-0-5v fr-px-2v">
        {% ui_select_rich_multi label="Filières" name="filieres" searchable=True options=filter_filieres initials=filter_filieres_initials %}
      </div>
      <div class="fr-col fr-col-sm-6 fr-col-lg-4 fr-py-0-5v fr-px-2v">
        {% ui_select_rich_multi label="Besoins" helper="Difficulté urgente, nouvelles pratiques, etc." name="themes" searchable=True options=filter_themes initials=filter_themes_initials %}
      </div>
      <div class="fr-col fr-col-sm-6 fr-col-lg-4 fr-py-0-5v fr-px-2v">
        {% ui_select_rich_multi label="Types de dispositif" helper="Investissement, conseil, assistance, etc." name="types" options=filter_types initials=filter_types_initials %}
      </div>
      <div class="fr-col fr-col-sm-6 fr-col-lg-4 fr-py-0-5v fr-px-2v">
        {% ui_select_rich_multi label="Types de bénéficiaires" helper="Coopératives, OP, etc." name="beneficiaires" options=filter_beneficiaires initials=filter_beneficiaires_initials %}
      </div>
    </div>
    <div class="fr-grid-row fr-mb-2w">
      <div class="fr-col">
        <div class="fr-tags-group">
          {% for filtered_departement in filtered_departements %}
            <label for="select-rich-departements-option-{{ filtered_departement.code }}"
                   class="fr-tag fr-tag--remove-filter"
                   aria-label="Supprimer le filtre sur le département {{ filtered_departement.code }}"
            >Département : {{ filtered_departement.code }}</label>
          {% endfor %}
          {% for filtered_type in filtered_types %}
            <label for="select-rich-types-option-{{ filtered_type.pk }}"
                   class="fr-tag fr-tag--remove-filter"
                   aria-label="Supprimer le filtre sur le type d’aides {{ filtered_type.nom }}"
            >Type : {{ filtered_type.nom }}</label>
          {% endfor %}
          {% for filtered_beneficiaire in filtered_beneficiaires %}
            <label for="select-rich-beneficiaires-option-{{ filtered_beneficiaire.pk }}"
                   class="fr-tag fr-tag--remove-filter"
                   aria-label="Supprimer le filtre sur le type de bénéficiaires {{ filtered_beneficiaire.nom }}"
            >Bénéficiaires : {{ filtered_beneficiaire.nom }}</label>
          {% endfor %}
          {% for filtered_filiere in filtered_filieres %}
            <label for="select-rich-filieres-option-{{ filtered_filiere.pk }}"
                   class="fr-tag fr-tag--remove-filter"
                   aria-label="Supprimer le filtre sur la filière {{ filtered_filiere.nom }}"
            >Filière : {{ filtered_filiere.nom }}</label>
          {% endfor %}
          {% for filtered_theme in filtered_themes %}
            <label for="select-rich-themes-option-{{ filtered_theme.pk }}"
                   class="fr-tag fr-tag--remove-filter"
                   aria-label="Supprimer le filtre sur le theme {{ filtered_theme.nom_court }}"
            >Besoin : {{ filtered_theme.nom_court }}</label>
          {% endfor %}
          <div class="fr-ml-2w">
            <a class="fr-btn fr-btn--secondary fr-btn--sm" href="{% url 'agri_v2:results' %}{% querystring themes=None types=None filieres=None beneficiaires=None q=None %}">
              Effacer les filtres
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col fr-col-md-3 fr-select-group">
        <label class="fr-label" for="select-tri">Trier les résultats</label>
        <select class="fr-select" id="select-tri" name="tri">
          <option value="pertinence" {% if order_by == "pertinence" %}selected{% endif %}>Pertinence</option>
          <option value="publication" {% if order_by == "publication" %}selected{% endif %}>Date de publication : du plus récent au plus ancien</option>
          <option value="cloture" {% if order_by == "cloture" %}selected{% endif %}>Date de clôture : du plus proche au plus lointain</option>
        </select>
      </div>
      <div class="fr-col fr-col-md-4 fr-col--bottom fr-mb-3w">
        <div class="fr-toggle">
          <input type="checkbox"
                 class="fr-toggle__input"
                 id="toggle-inclure-fermes"
                 name="inclure_fermes"
                 {% if include_closed %}checked{% endif %}
                 {% if not can_include_closed %}disabled{% endif %}
          >
          <label class="fr-toggle__label"
                 for="toggle-inclure-fermes"
                 data-fr-checked-label="Inclus"
                 data-fr-unchecked-label="Exclus">
            Inclure les dispositifs fermés
          </label>
        </div>
      </div>
      <div id="actions" class="fr-col fr-col--bottom fr-mb-3w fr-grid-row fr-grid-row--reverse">
        <button type="button"
                class="fr-btn fr-btn--icon-left fr-btn--secondary fr-icon-mail-line"
                aria-controls="modal-send-by-mail"
                data-fr-opened="false"
        >
          Recevoir par e-mail
        </button>
        <button type="button"
                class="fr-btn fr-btn--icon-left fr-btn--secondary fr-icon-file-pdf-line"
                id="button-print"
                data-action="click->matomo#trackEvent"
                data-event-page="Recommandation"
                data-event-name="Impression"
        >
          Enregistrer en PDF
        </button>
      </div>
    </div>
  </form>

  <div class="fr-container fr-p-0 fr-my-2w">
    <div id="recommandation" class="fr-mb-5w">
      {% for aide in aides %}
        {% dsfr_card aide %}
      {% empty %}
        {% dsfr_alert type="info" content="Le service Aides Agri est en phase d’expérimentation, ce qui veut dire que le recensement et la mise à jour de notre catalogue est en cours. Dans l’attente, nous vous invitons à consulter les sites de vos interlocuteurs locaux : Région, Département, DDT, Chambre d’agriculture." %}
      {% endfor %}
    </div>
    <div class="fr-grid-row fr-grid-row--center fr-my-2w">
      {% dsfr_pagination page_obj %}
    </div>
  </div>
{% endblock content %}

{% block aftercontent %}
  {% include "aides_feedback/blocks/create_feedback_on_aides.html" with form=create_feedback_on_aides_form %}
{% endblock aftercontent %}
