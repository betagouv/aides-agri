{% extends "agri/_base.html" %}

{% load static dsfr_tags %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'agri/results.css' %}">

  <script type="importmap">
  {
    "imports": {
      "@hotwired/stimulus": "{% static 'vendor/stimulus.js' %}",
      "summary-mobile": "{% static 'agri/summary-mobile.js' %}"
    }
  }
  </script>
  <script type="module">
    import { Application } from "@hotwired/stimulus"
    import { SummaryMobile } from "summary-mobile"

    window.Stimulus = Application.start()

    Stimulus.register("summary-mobile", SummaryMobile)
  </script>
{% endblock extra_css %}

{% block extra_js %}
  {{ block.super }}
  <script type="module" src="{% static 'vendor/htmx.esm.js' %}"></script>
{% endblock extra_js %}

{% block modals %}
<dialog class="fr-modal"
        id="modal-send-by-mail"
        aria-labelledby="modal-send-by-mail-title"
>
  <div class="fr-container fr-container--fluid fr-container-md">
    <div class="fr-grid-row fr-grid-row--center">
      <div class="fr-col-12 fr-col-md-8 fr-col-lg-7">
        <div class="fr-modal__body">
          <form method="post"
                action="{% url 'agri:send-results-by-mail' %}{% querystring %}"
                hx-boost="true"
                hx-target="#modal-send-by-mail-content"
                hx-push-url="false"
          >
            {% csrf_token %}
            <div class="fr-modal__header">
              <button class="fr-btn--close fr-btn" aria-controls="modal-send-by-mail">Fermer</button>
            </div>
            <div class="fr-modal__content" id="modal-send-by-mail-content">
              <h1 id="modal-send-by-mail-title" class="fr-modal__title">
                <span class="fr-icon-arrow-right-line fr-icon--lg"></span>
                S’envoyer les résultats de la recherche par e-mail.
              </h1>
              <p>Partagez-nous votre adresse e-mail pour recevoir vos résultats dans votre boite e-mail. Nous utiliserons votre adresse e-mail seulement à cet effet.</p>
                <div class="fr-input-group">
                  <label for="send-by-mail-field-email" class="fr-label">
                    Adresse de courrier électronique
                    <span class="fr-hint-text">Format attendu : nom@domaine.fr</span>
                  </label>
                  <input type="email"
                         name="email"
                         id="send-by-mail-field-email"
                         class="fr-input"
                         required
                  >
                </div>
            </div>
            <div class="fr-modal__footer" id="modal-send-results-by-mail-footer">
              <div class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left">
                <button class="fr-btn fr-icon-checkbox-circle-line fr-btn--icon-left">Envoyer par e-mail</button>
                <button class="fr-btn fr-btn--secondary" aria-controls="modal-send-by-mail">Annuler</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</dialog>
{% endblock modals %}

{% block aside_tools %}
  <button type="button"
          class="fr-btn fr-btn--icon-left fr-btn--sm fr-pl-0 fr-btn--tertiary-no-outline fr-icon-mail-line"
          aria-controls="modal-send-by-mail"
          data-fr-opened="false"
  >
    M’envoyer la recherche
  </button>
{% endblock aside_tools %}

{% block title %}Nos recommandations{% endblock title %}
{% block h1 %}Pour votre besoin et profil d’exploitant.{% endblock h1 %}

{% block main_col %}
<div class="fr-col fr-col-12 fr-col-md-9">
  <div class="fr-highlight">
    <p>La recommandation de ces dispositifs se base sur les informations que vous nous avez fournies en amont. Elle n’assure pas votre éligibilité.</p>
    <p>Nous nous efforçons de recenser et mettre à jour notre catalogue en construction. Il se peut que certaines aides ne soient pas encore recensées par notre équipe.</p>
  </div>

  <div class="fr-container fr-p-0 fr-mb-6w">
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col fr-col-12">
        <div class="fr-accordions-group">
        {% for type_aide, aide_list in aides.items %}
          <section class="fr-accordion">
            <h3 class="fr-accordion__title">
              <button type="button"
                      class="fr-accordion__btn"
                      aria-expanded="false"
                      aria-controls="accordeon-type-{{ forloop.counter }}"
              >
                {{ type_aide.nom }}
                <span class="fr-text--xs fr-text-mention--grey fr-text--regular fr-ml-2v fr-hidden fr-unhidden-sm">
                  {{ type_aide.description }}
                </span>
                <p class="fr-badge fr-badge--sm fr-badge--info fr-badge--no-icon fr-ml-2v">
                  {{ aide_list|length }} aide{{ aide_list|pluralize }} disponible{{ aide_list|pluralize }}
                </p>
              </button>
            </h3>
            <div id="accordeon-type-{{ forloop.counter }}" class="fr-collapse">
              {% for aide in aide_list %}
              <div class="fr-col fr-col-12 fr-mb-1w">
                {% dsfr_card aide %}
              </div>
              {% endfor %}
            </div>
          </section>
        {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock main_col %}
